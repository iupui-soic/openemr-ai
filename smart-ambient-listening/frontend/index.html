<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambient Listening - SMART on FHIR</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="container">
    <header>
        <h1>Ambient Clinical Listening</h1>
        <div id="patient-banner" class="patient-banner hidden">
            <span id="patient-name"></span>
            <span id="patient-dob"></span>
            <span id="patient-mrn"></span>
        </div>
    </header>

    <main>
        <!-- Connection Status -->
        <div id="connection-status" class="status-bar">
            <span class="status-indicator disconnected"></span>
            <span id="status-text">Not connected to EHR</span>
        </div>

        <!-- Recording Controls -->
        <section class="recording-section">
            <div class="recording-controls">
                <button id="btn-ambient" class="btn btn-primary btn-large" disabled>
                        <span class="btn-icon">
                            <svg viewBox="0 0 24 24" width="32" height="32">
                                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            </svg>
                        </span>
                    <span class="btn-text">Start Ambient Listening</span>
                </button>
            </div>

            <div id="recording-status" class="recording-status hidden">
                <div class="recording-indicator">
                    <span class="pulse"></span>
                    <span>Recording...</span>
                </div>
                <div id="recording-timer">00:00</div>
                <div class="audio-visualizer">
                    <canvas id="visualizer" width="300" height="60"></canvas>
                </div>
            </div>
        </section>

        <!-- Transcription Results -->
        <section class="transcription-section">
            <h2>Transcription</h2>
            <div id="transcription-container">
                <div id="transcription-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <span>Transcribing audio...</span>
                </div>
                <div id="transcription-results" class="transcription-results">
                    <p class="placeholder-text">
                        Click "Start Ambient Listening" to begin capturing audio.
                        The transcription will appear here.
                    </p>
                </div>
            </div>

            <!-- Transcription History -->
            <div id="transcription-history" class="history-section hidden">
                <h3>Session History</h3>
                <div id="history-list" class="history-list"></div>
            </div>
        </section>

        <!-- Actions -->
        <section class="actions-section hidden" id="actions-section">
            <button id="btn-copy" class="btn btn-secondary">Copy Transcription</button>
            <button id="btn-summarize" class="btn btn-primary">Generate SOAP Note</button>
            <button id="btn-clear" class="btn btn-secondary">Clear Session</button>
        </section>

        <!-- vishnu added: Console-only viewer start -->
        <section class="console-viewer-section">
            <h2>Patient data needed for summarization</h2>
            <pre id="console-output" style="background:#f0f0f0; padding:10px; border:1px solid #ccc; max-height:300px; overflow:auto;"></pre>
        </section>
        <!-- vishnu added: Console-only viewer end-->

        <!-- SOAP Note Section -->
        <section class="soap-section hidden" id="soap-section">
            <h2>SOAP Note</h2>
            <div id="soap-container">
                <div id="soap-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <span>Generating SOAP note... This may take 1-2 minutes.</span>
                </div>
                <div id="soap-results" class="soap-results">
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>SMART on FHIR Application | Powered by NVIDIA Parakeet ASR</p>
    </footer>
</div>

<!-- Error Modal -->
<div id="error-modal" class="modal hidden">
    <div class="modal-content">
        <h3>Error</h3>
        <p id="error-message"></p>
        <button id="btn-close-error" class="btn btn-primary">Close</button>
    </div>
</div>

<!-- Permission Modal -->
<div id="permission-modal" class="modal hidden">
    <div class="modal-content">
        <h3>Microphone Access Required</h3>
        <p>This application needs access to your microphone to capture audio for transcription.</p>
        <button id="btn-request-permission" class="btn btn-primary">Request Permission</button>
    </div>
</div>

<!-- Configuration (set by deployment) -->
<script>
    window.SMART_CONFIG = {
        clientId: 'smart-ambient-listening',
        scope: 'launch patient/Patient.read patient/Condition.read patient/Procedure.read patient/Observation.read patient/MedicationRequest.read patient/AllergyIntolerance.read openid fhirUser',
        // Set this to your transcription service URL
        transcriptionServiceUrl: 'https://vishnu.b691.us'
    };
</script>

<script src="js/fhirclient.min.js"></script>
<script src="js/ambient-recorder.js"></script>
<script src="js/app.js"></script>
<!-- vishnu added: Console-only viewer -->
<script src="js/consoleViewer.js"></script>
</body>
</html>